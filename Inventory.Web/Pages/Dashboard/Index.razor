@attribute [Authorize]
@page "/"
@inject Inventory.Core.Services.ProductService ProductService
@inject Inventory.Core.Services.StockInService StockInService
@inject Inventory.Core.Services.StockOutService StockOutService
@inject Inventory.Core.Services.SupplierService SupplierService
@inject Inventory.Core.Services.CustomerService CustomerService

<h3>Dashboard</h3>

<div class="grid">
    <div class="card center">
        <h4>Total Products</h4>
        <p style="font-size:24px; margin:8px 0;">@productsCount</p>
        <div class="text-muted">@categoriesCount categories</div>
    </div>

    <div class="card center">
        <h4>Stock In (total)</h4>
        <p style="font-size:24px; margin:8px 0;">@stockInTotal</p>
        <div class="text-muted">@recentStockInCount recent</div>
    </div>

    <div class="card center">
        <h4>Stock Out (total)</h4>
        <p style="font-size:24px; margin:8px 0;">@stockOutTotal</p>
        <div class="text-muted">@recentStockOutCount recent</div>
    </div>
</div>

<div style="height:12px"></div>

<div class="tx-grid">
    <div class="card">
        <h4 style="margin-bottom:10px">Recent Stock In</h4>
        <table class="table">
            <thead><tr><th>Date</th><th>Product</th><th>Supplier</th><th>Qty</th></tr></thead>
            <tbody>
                @foreach (var si in recentStockIns)
                {
                    <tr>
                        <td>@si.DateIn.ToString("g")</td>
                        <td>@GetProductName(si.ProductId)</td>
                        <td>@GetSupplierName(si.SupplierId)</td>
                        <td>@si.Quantity</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="card">
        <h4 style="margin-bottom:10px">Recent Stock Out</h4>
        <table class="table">
            <thead><tr><th>Date</th><th>Product</th><th>Customer</th><th>Qty</th></tr></thead>
            <tbody>
                @foreach (var so in recentStockOuts)
                {
                    <tr>
                        <td>@so.Date.ToString("g")</td>
                        <td>@GetProductName(so.ProductId)</td>
                        <td>@GetCustomerName(so.CustomerId)</td>
                        <td>@so.Quantity</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    int productsCount = 0, categoriesCount = 0;
    int recentStockInCount = 0, recentStockOutCount = 0;
    int stockInTotal = 0, stockOutTotal = 0;

    List<Inventory.Core.Models.StockIn> recentStockIns = new();
    List<Inventory.Core.Models.StockOut> recentStockOuts = new();
    List<Inventory.Core.Models.Product> products = new();
    List<Inventory.Core.Models.Supplier> suppliers = new();
    List<Inventory.Core.Models.Customer> customers = new();

    protected override void OnInitialized()
    {
        products = ProductService.GetAll() ?? new();
        suppliers = SupplierService.GetAll() ?? new();
        customers = CustomerService.GetAll() ?? new();

        productsCount = products.Count;
        categoriesCount = ProductService.GetAll().Select(p => p.CategoryId).Distinct().Count();

        var allIn = StockInService.GetAll() ?? new();
        var allOut = StockOutService.GetAll() ?? new();

        stockInTotal = allIn.Sum(x => x.Quantity);
        stockOutTotal = allOut.Sum(x => x.Quantity);

        recentStockIns = allIn.OrderByDescending(x => x.DateIn).Take(6).ToList();
        recentStockOuts = allOut.OrderByDescending(x => x.Date).Take(6).ToList();

        recentStockInCount = recentStockIns.Count;
        recentStockOutCount = recentStockOuts.Count;
    }

    string GetProductName(int id) => products.FirstOrDefault(p => p.Id == id)?.Name ?? "-";
    string GetSupplierName(int id) => suppliers.FirstOrDefault(s => s.Id == id)?.Name ?? "-";
    string GetCustomerName(int id) => customers.FirstOrDefault(c => c.Id == id)?.Name ?? "-";
}
